{% extends "base.html" %}
{% load static %}

{% block content %}
<div class="container py-5 text-center text-gold">

  <h1 class="text-gold mb-4 text-uppercase fw-bold">Dungeon Master Dashboard</h1>

  {% if messages %}
    {% for message in messages %}
      <div class="alert alert-{{ message.tags }} bg-dark text-gold border-gold mb-3">
        {{ message }}
      </div>
    {% endfor %}
  {% endif %}

  <!-- Filter by Player (visible only to DMs) -->
    {% if is_dm and players %}
    <div class="text-center mb-4">
      <form method="get" class="d-inline-flex align-items-center gap-2">
        <label for="player" class="fw-bold text-gold">Filter by Player:</label>
        <select name="player" id="player" class="form-select w-auto text-center" onchange="this.form.submit()">
          <option value="all" {% if not selected_player_id or selected_player_id == 'all' %}selected{% endif %}>All Players</option>
          {% for player in players %}
          <option value="{{ player.id }}" {% if selected_player_id == player.id|stringformat:"s" %}selected{% endif %}>
            {{ player.username }}
          </option>
          {% endfor %}
        </select>
      </form>
    </div>
    {% endif %}

  <!-- Create New Party -->
  <div class="card bg-dark border-gold text-gold mb-5">
    <div class="card-header text-uppercase fw-bold border-bottom border-gold">
      Create a New Party
    </div>
    <div class="card-body">
      <form method="POST" class="d-flex justify-content-center align-items-center gap-2">
        {% csrf_token %}
        <input type="text" name="party_name" class="form-control w-50 text-center" placeholder="Enter party name" required />
        <button type="submit" name="create_party" class="btn btn-warning fw-bold text-dark px-4">
          Create
        </button>
      </form>
    </div>
  </div>

  <!-- Your Parties -->
  <div class="card bg-dark border-gold text-gold">
    <div class="card-header text-uppercase fw-bold border-bottom border-gold">
      Your Parties
    </div>
    <div class="card-body">
      {% if parties %}
        <div class="row justify-content-center">
          {% for party in parties %}
            <div class="col-md-5 col-lg-4 mb-4">
              <div class="card party-card bg-dark border-gold h-100">
                <div class="card-body">
                  <h4 class="card-title text-gold">{{ party.name }}</h4>
                  <p class="mb-2"><strong>Members:</strong> {{ party.members.count }}</p>
                  <p class="mb-3"><strong>DM:</strong> {{ party.dungeon_master.username }}</p>

                  <div class="d-flex justify-content-center gap-2 mt-3">
                    <a href="{% url 'party_detail' party.pk %}" class="btn btn-gold fw-bold px-3">
                      View Party
                    </a>

                    <form method="POST" onsubmit="return confirm('Are you sure you want to delete {{ party.name }}?');">
                      {% csrf_token %}
                      <input type="hidden" name="party_id" value="{{ party.id }}">
                      <button type="submit" name="delete_party" class="btn btn-danger fw-bold px-3">
                        Delete
                      </button>
                    </form>
                  </div>
                </div>
              </div>
            </div>
          {% endfor %}
        </div>
      {% else %}
        <p class="mb-0">You havenâ€™t created any parties yet.</p>
      {% endif %}
    </div>
  </div>

</div>
{% endblock %}
